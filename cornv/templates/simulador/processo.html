{% extends 'partials/base.html' %}
{% block title %}Processo de moagem{% endblock %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %} 

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const moagemTable = document.querySelector("#moagemTable");
        if (moagemTable) {
            new simpleDatatables.DataTable(moagemTable);
        }

        const liquefacaoTable = document.querySelector("#liquefacaoTable");
        if (liquefacaoTable) {
            new simpleDatatables.DataTable(liquefacaoTable);
        }
    });
</script>

<div class="container-fluid mt-4 p-3">
    <div class="row justify-content-center mb-4">
        <div class="col-lg-3 col-md-4 col-sm-12 mb-3">
            {% for message in messages %}
            {% if message %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endif %}
            {% endfor %}

            <div class="border bg-white p-3 h-100">
                <h4>Moer milho</h4>
                <hr>
                <form method="POST" action="">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <input class="btn btn-success btn-block" type="submit" value="Converter">
                </form>
            </div>
        </div>

        <div class="mb-3">
            <label for="selecao-simulacao" class="form-label"><strong>Selecionar simulação recente:</strong></label>
            <select id="selecao-simulacao" class="form-select" onchange="exibirSimulacaoSelecionada(this)">
                {% for simulacao in ultimas_simulacoes %}
                    <option value="{{ simulacao.id }}">{{ simulacao.data }} - {{ simulacao.quantidade_milho }} kg</option>
                {% endfor %}
            </select>
        </div>

        <div id="card-simulacao" class="card bg-light border p-4 mb-4 d-none">
    <h5 class="card-title">Dados da simulação de <span id="data-simulacao"></span></h5>
    <p><strong>Milho:</strong> <span id="milho"></span> kg</p>
    <p><strong>Milho moído:</strong> <span id="milho-moido"></span> kg</p>
    <p><strong>Energia total:</strong> <span id="energia"></span> kWh</p>
    <div id="dados-liquefacao" class="mt-3 d-none">
        <h6>Liquefação</h6>
        <p><strong>Amido convertido:</strong> <span id="amido"></span> kg</p>
        <p><strong>Conversão do amido:</strong> <span id="conversao-amido"></span>%</p>
        <p><strong>Tempo:</strong> <span id="tempo"></span> h</p>
        <p><strong>Volume da reação:</strong> <span id="volume"></span> L</p>
        <p><strong>Conc. amido final:</strong> <span id="conc-amido"></span> kg/L</p>
        <p><strong>ART gerada:</strong> <span id="art"></span> kg</p>
        <p><strong>Conversão percentual:</strong> <span id="percentual"></span>%</p>
        <p><strong>Enzima:</strong> <span id="enzima"></span> g</p>
    </div>
</div>

<div id="grafico-liquefacao" class="mb-4" style="width: 100%; height: 400px;"></div>
</div>


<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>
<script src="{% static '/js/plotly-3.0.1.min.js' %}" charset="utf-8"></script>


<script>
    // Variável global com dados das simulações, inserida pelo Django no template
    const simulacoes = {{ simulacoes_json|safe }};

    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM carregado");

        // Inicializa a tabela de moagem, se existir
        const moagemTable = document.querySelector("#moagemTable");
        if (moagemTable) {
            console.log("Inicializando tabela moagemTable");
            new simpleDatatables.DataTable(moagemTable);
        } else {
            console.log("moagemTable não encontrado");
        }

        // Inicializa a tabela de liquefação, se existir
        const liquefacaoTable = document.querySelector("#liquefacaoTable");
        if (liquefacaoTable) {
            console.log("Inicializando tabela liquefacaoTable");
            new simpleDatatables.DataTable(liquefacaoTable);
        } else {
            console.log("liquefacaoTable não encontrado");
        }

        console.log("Variável simulacoes:", simulacoes);

        // Se existirem simulações, seleciona a primeira automaticamente e exibe os dados
        if (simulacoes.length > 0) {
            const select = document.getElementById('selecao-simulacao');
            select.value = simulacoes[0].id;  // seleciona a primeira opção
            console.log("Selecionando primeira simulação com id:", simulacoes[0].id);
            exibirSimulacaoSelecionada(select);  // exibe gráfico e dados da simulação selecionada
        } else {
            console.log("Nenhuma simulação encontrada");
        }
    });

    // Função que atualiza os dados exibidos na página quando uma simulação é selecionada
    function exibirSimulacaoSelecionada(select) {
    // Pega o id selecionado no select e converte para número inteiro
    const idSelecionado = parseInt(select.value);
    console.log("Selecionando simulação com id:", idSelecionado);

    // Busca a simulação na lista 'simulacoes' pelo id
    const simulacao = simulacoes.find(s => s.id === idSelecionado);

    // Se não encontrar a simulação, exibe erro e sai da função
    if (!simulacao) {
        console.error("Simulação não encontrada para o id:", idSelecionado);
        return;
    }

    // Atualiza os dados básicos no card HTML
    document.getElementById('data-simulacao').textContent = simulacao.data;
    document.getElementById('milho').textContent = simulacao.milho;
    document.getElementById('milho-moido').textContent = simulacao.milho_moido;
    document.getElementById('energia').textContent = simulacao.energia;

    // Mostra o card com os dados
    document.getElementById('card-simulacao').classList.remove('d-none');

    console.log("Dados da simulação:", simulacao);

    // Verifica se existem dados de liquefação
    if (simulacao.liquefacao) {
        console.log("Simulação possui dados de liquefação:", simulacao.liquefacao);

        // Mostra a seção de dados de liquefação
        document.getElementById('dados-liquefacao').classList.remove('d-none');

        // Preenche os dados de liquefação nos elementos HTML
        const liquef = simulacao.liquefacao;
        document.getElementById('amido').textContent = liquef.amido;
        document.getElementById('conversao-amido').textContent = liquef.conversao_amido;
        document.getElementById('tempo').textContent = liquef.tempo;
        document.getElementById('volume').textContent = liquef.volume;
        document.getElementById('conc-amido').textContent = liquef.conc_amido;
        document.getElementById('art').textContent = liquef.art;
        document.getElementById('percentual').textContent = liquef.percentual;
        document.getElementById('enzima').textContent = liquef.enzima;

        // Pega os dados do gráfico
        const grafico = liquef.grafico;
        console.log("Dados do gráfico:", grafico);

        // Valida o objeto do gráfico e seus dados
        if (!grafico) {
            console.error("Objeto gráfico não encontrado.");
            document.getElementById('grafico-liquefacao').innerHTML = 'Dados do gráfico indisponíveis.';
            return;
        }
        if (!Array.isArray(grafico.data) || grafico.data.length === 0) {
            console.error("Dados do gráfico inválidos ou vazios.");
            document.getElementById('grafico-liquefacao').innerHTML = 'Dados do gráfico inválidos ou vazios.';
            return;
        }

        // Tenta plotar o gráfico com Plotly
        try {
            Plotly.newPlot('grafico-liquefacao', grafico.data, grafico.layout);
            console.log("Gráfico plotado com sucesso.");
        } catch (e) {
            console.error("Erro ao plotar gráfico:", e);
            document.getElementById('grafico-liquefacao').innerHTML = 'Erro ao gerar o gráfico.';
        }

    } else {
        // Se não houver dados de liquefação, esconde essa seção e limpa o gráfico
        console.warn("Simulação não possui dados de liquefação.");
        document.getElementById('dados-liquefacao').classList.add('d-none');
        document.getElementById('grafico-liquefacao').innerHTML = '';
    }
}

</script>


{% endblock %}
